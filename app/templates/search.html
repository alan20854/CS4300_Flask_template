<html>
    <head>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="/static/bootstrap.min.css">
        <link href="./static/css/custom.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/main.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    </head>
    <body>
        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <div class="topcorner">
            <p>Student Names: ({{ netid }})</p>
        </div>
        <h1 style="font-size: 55px; font-family:Futura; color: #222222; text-align:center">CourseFinder</h1>
        <!--<form class="form-inline global-search" method="get" id="classform">
            
            
            <br><br>
            <button type="submit" class="btn btn-info"> Go! </button>
        </form>-->

        {% extends "main-typeahead.html" %}
        {% block content %}
        <link rel="stylesheet" href="/static/main.css">
        <script src="https://d3js.org/d3.v3.min.js"></script>

          <div id = "shit">
            <div id = "search-inputs-flex-container">
                <div class="dropdown-bar">
                    <input type="text" id="class-search" data-role="tagsinput" placeholder="Enter Class You Liked"/>
                </div>
                <div class="dropdown-bar">
                    <input type="text" id="tag-search" data-role="tagsinput" placeholder="Enter Topics of Interest"/>
                </div>
                
                <!--<div onclick="search()">
                    <button type="submit"> Go! </button>
                </div>-->
                <button id="search-button" onclick="search()" type="submit">Search</button>
                <div id = "advanced-search">
                  <a onclick = "showAdvancedSearch()">Advanced Search</a>
                </div>
            </div>
          </div>
          <div id = "advanced-search-options">
            <div id = "slider-container">
              <div id = "slider-text">
                <p>Priotize classes or topics:</p>
              </div>

              <div id = "slider-choices">
                <div id = "slider-choices-1">
                  <p> classes</p>
                </div>
                <div id = "slider-choices-2">
                  <p> topics</p>
                </div>
              </div>

              <div id="slider">
                  <div id="custom-handle" class="ui-slider-handle"></div>
              </div>
            </div>
          </div>

        <div id = "results"></div>

        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script>
         $( function() {
          var handle = $( "#custom-handle" );
          $( "#slider" ).slider({
            create: function() {
              handle.text( $( this ).slider( "value" ) );
            },
            slide: function( event, ui ) {
              handle.text( ui.value );
            }
          });
        } );

        function showAdvancedSearch() {
          var advanced_search = document.getElementById("advanced-search-options");
          console.log(advanced_search.style.display);
            if (advanced_search.style.display == "none" || !advanced_search.style.display) {
              advanced_search.style.display = "block";
            } else {
              advanced_search.style.display = "none";
            }
        }
        </script>
        <script>
        var classes = new Bloodhound({
          datumTokenizer: Bloodhound.tokenizers.obj.whitespace('class_name'),
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          prefetch: {
            url: 'static/classes_typeahead.json',
            filter: function(list) {
            return list.classes;
            }
          }
        });

        classes.clearPrefetchCache();
        classes.initialize();

        var elt = $('#class-search');
        elt.tagsinput({
          itemValue: 'class_name',
          itemText: function(c){
            return c.class_name.slice(0, c.class_name.indexOf(':'));
            },
          typeaheadjs: {
            name: 'classes',
            limit: 10,
            displayKey: function(c){
              return c.class_name;
            },
            source: classes.ttAdapter()
          }
        });

        var tags = new Bloodhound({
          datumTokenizer: Bloodhound.tokenizers.obj.whitespace('tag'),
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          prefetch: {
            url: 'static/tags_typeahead.json',
            filter: function(list) {
            return list.tags;
            }
          }
        });

        tags.clearPrefetchCache();
        tags.initialize();

        var tag_elt = $('#tag-search');
        tag_elt.tagsinput({
          itemValue: 'tag',
          itemText: function(t){
            return t.tag;
            },
          typeaheadjs: {
            name: 'tags',
            limit: 10,
            displayKey: function(t){
              return t.tag;
            },
            source: tags.ttAdapter()
          }
        });

       
        function getIconForMajor(dept) {
          let majorToIconMapping = {"HADM": "fas fa-hotel", "ENGRG": "fas fa-cogs", "ENGRC": "fas fa-cogs", "BIOEE": "fas fa-biohazard", "BIOG": "fas fa-seedling", "LATA": "fas fa-language", "ESS": "fas fa-tree", "ART": "fas fa-palette", "PORT": "fas fa-language", "TIBET": "fas fa-language", "ANSC": "fas fa-hippo", "VIEN": "fas fa-wine-glass-alt", "LAW": "fas fa-university", "ECON": "fas fa-money-check-alt", "MILS": "fas fa-fighter-jet", "NS": "fas fa-hamburger", "PUNJ": "fas fa-language", "AMST": "fas fa-flag-usa", "FGSS": "fas fa-venus-double", "ENTOM": "fas fa-spider", "KHMER": "fas fa-language", "SPAN": "fas fa-language", "PHIL": "fas fa-language", "SNLIT": "fas fa-language", "PMA": "fas fa-video-slash", "AGSCI": "fas fa-tractor", "ITAL": "fas fa-language", "MAE": "fas fa-hammer", "BIOMG": "fas fa-dna", "VTPMD": "fas fa-dog", "CHIN": "fas fa-language", "CRP": "fas fa-city", "LATIN": "fas fa-language", "CEE": "fas fa-road", "DUTCH": "fas fa-language", "ILRLE": "fas fa-briefcase", "NMI": "fas fa-tasks", "DSOC": "fas fa-people-carry", "VETMM": "fas fa-dog", "MATH": "fas fa-square-root-alt", "NBAY": "fas fa-business-time", "ENMGT": "fas fa-business-time", "RUSSL": "fas fa-language", "PLSCI": "fas fa-seedling", "COML": "fas fa-book", "BTRY": "fas fa-dice", "AEM": "fas fa-business-time", "NTRES": "fas fa-gas-pump", "HE": "fas fa-biohazard", "LGBT": "fas fa-equals", "PLBIO": "fas fa-seedling", "BEE": "fas fa-seedling", "BENGL": "fas fa-language", "TECH": "fas fa-sim-card", "SINHA": "fas fa-language", "AEP": "fas fa-atom", "BSOC": "fas fa-tree", "IM": "fas fa-male", "GRAD": "fas fa-search", "PAM": "fas fa-briefcase", "CHEME": "fas fa-atom", "WRIT": "fas fa-pencil-alt", "NRE": "fas fa-search", "TOX": "fas fa-search", "LING": "fas fa-microphone-alt", "ARTH": "fas fa-paint-brush", "RELST": "fas fa-quran", "ENGRD": "fas fa-cogs", "ARAB": "fas fa-language", "SYSEN": "fas fa-space-shuttle", "SANSK": "fas fa-language", "GOVT": "fas fa-gavel", "BIOMI": "fas fa-allergies", "NES": "fas fa-language", "NBA": "fas fa-briefcase", "NACCT": "fas fa-briefcase", "RUSSA": "fas fa-language", "ILRLR": "fas fa-history", "COLLS": "fas fa-graduation-cap", "MSE": "fas fa-sim-card", "POLSH": "fas fa-language", "BIOMS": "fas fa-allergies", "PE": "fas fa-dumbbell", "KOREA": "fas fa-language", "GREEK": "fas fa-language", "AIRS": "fas fa-space-shuttle", "GERST": "fas fa-language", "VIET": "fas fa-language", "CS": "fas fa-laptop-code", "ROMAN": "fas fa-language", "COMM": "fas fa-volume-up", "COGST": "fas fa-brain", "IARD": "fas fa-tractor", "PLHRT": "fas fa-tractor", "WOLOF": "fas fa-language", "HINDI": "fas fa-language", "INFO": "fas fa-laptop-code", "MEDVL": "fas fa-chess-rook", "ARKEO": "fas fa-skull", "CAPS": "fas fa-language", "NCC": "fas fa-briefcase", "ILRHR": "fas fa-user", "INDO": "fas fa-language", "PSYCH": "fas fa-brain", "ILRIC": "fas fa-user", "EDUC": "fas fa-book-reader", "VETCS": "fas fa-dog", "ELSO": "fas fa-sign-language", "BIOAP": "fas fa-dog", "LA": "fas fa-mountain", "ROMS": "fas fa-language", "ZULU": "fas fa-language", "ARCH": "fas fa-monument", "CZECH": "fas fa-language", "SWAHL": "fas fa-language", "PALI": "fas fa-language", "VISST": "fas fa-tv", "ENGL": "fas fa-language", "VTMED": "fas fa-dog", "THAI": "fas fa-language", "ECE": "fas fa-microchip", "LSP": "fas fa-language", "HIST": "fas fa-history", "SOC": "fas fa-democrat", "DEA": "fas fa-biohazard", "PERSN": "fas fa-language", "HD": "fas fa-baby", "STS": "fas fa-microscope", "NSE": "fas fa-biohazard", "AIIS": "fas fa-language", "ORIE": "fas fa-bezier-curve", "NAVS": "fas fa-water", "SHUM": "fas fa-user-alt", "ENGRI": "fas fa-cogs", "FSAD": "fab fa-pied-piper-hat", "FDSC": "fas fa-utensils", "ASTRO": "fas fa-meteor", "VTBMS": "fas fa-dog", "PLPPM": "fab fa-canadian-maple-leaf", "JAPAN": "fas fa-language", "PADM": "fas fa-bus", "ILRID": "fas fa-user", "PLBRG": "fas fa-seedling", "NEPAL": "fas fa-language", "CLASS": "fas fa-globe", "BURM": "fas fa-language", "CHEM": "fas fa-flask", "MGMT": "fas fa-graduation-cap", "JWST": "fas fa-hanukiah", "HEBRW": "fas fa-language", "PLSCS": "fas fa-seedling", "FREN": "fas fa-language", "LEAD": "fas fa-fist-raised", "ILRST": "fas fa-user", "ASIAN": "fas fa-globe-asia", "ASRC": "fas fa-globe-africa", "STSCI": "fas fa-superscript", "TAG": "fas fa-language", "ALS": "fas fa-tractor", "BPRE": "fas fa-building", "BME": "fas fa-pills", "ILROB": "fas fa-calendar-alt", "TAMIL": "fas fa-language", "TURK": "fas fa-language", "ANTHR": "fas fa-user", "AAS": "fas fa-globe-asia", "PHYS": "fas fa-atom", "CHLIT": "fas fa-language", "JPLIT": "fas fa-language", "YORUB": "fas fa-language", "BIONB": "fas fa-brain", "URDU": "fas fa-language", "MUSIC": "fas fa-music", "VETMI": "fas fa-dog", "EAS": "fas fa-globe"};
          return majorToIconMapping[dept];
        }
        // Creates a div to hold everything to do with a recommenation
        function createRecommendationComponent(recommendation) {
          let course = recommendation.course;
          let description = recommendation.description;
          let title = recommendation.title;
          let professor = recommendation.professor;
          let rating = recommendation.rating;
          let isReplacementRating = JSON.parse(recommendation.replacementRating);
          let offered = recommendation.offered;
          let length = recommendation.length;
          
          let courseDept = course.split(' ')[0];
          console.log(courseDept);


          // Main div
          course_result = document.createElement("div");
          course_result.className = "course-result-div";
          

          // First child div
          course_result_information_div = document.createElement("div");
          course_result_information_div.className = "course-result-information-div";

          course_txt = document.createElement("p");
          course_txt.innerHTML = course

          description_txt = document.createElement("p");
          if (description == null || description.length == 0) {
              description = "No course description available."
          }

          description_txt = document.createElement("div");
          description_txt.className = "course-description more";
          description_txt.innerHTML = description;

          // Add course title "CS1110 - Introduction to Python" and course description 
          course_result_information_div.appendChild(course_txt);
          course_result_information_div.appendChild(description_txt);


          // Second child div
          course_result_metadata_div = document.createElement("div");
          course_result_metadata_div.className = "course-result-metadata-div";

          // Professor
          professor_txt = document.createElement("p");
          if (professor == null || professor.length == 0) {
            professor = "No professor information available."
          }

          professor_txt.innerHTML = 'Professor' + '<br>' + professor;
          course_result_metadata_div.appendChild(professor_txt);

          // Rating
          course_rating_txt = document.createElement("p");
          if (isReplacementRating || rating == null) {
            course_rating_txt.innerHTML = 'Course Rating: N/A';
          } else {
            course_rating_txt.innerHTML = 'Course Rating: ' + rating + '/5';
          }
          
          course_result_metadata_div.appendChild(course_rating_txt);

          // offered
          course_offered_txt = document.createElement("p");
          course_offered_txt.innerHTML = 'Course offered in: ' + offered;
          course_result_metadata_div.appendChild(course_offered_txt);

          // length
          course_length_txt = document.createElement("p");
          course_length_txt.innerHTML = 'Course is: ' + length + ' weeks';
          course_result_metadata_div.appendChild(course_length_txt);


          course_image = document.createElement("i");
          course_image.className = getIconForMajor(courseDept);
          // Add two child divs to parent div
          course_result.appendChild(course_result_information_div);
          course_result.appendChild(course_result_metadata_div);
          course_result.appendChild(course_image);
          return course_result;
        }

        function search(){
          //var class_results = document.getElementsByTagName("input")[0].value;
          var paras = document.getElementsByClassName('course-result-div');
          while (paras && paras[0]) {
            paras[0].parentNode.removeChild(paras[0]);
          }

          var class_results = document.getElementById("class-search").value;
          var tag_results = document.getElementById("tag-search").value;
          var custom_handle = document.getElementById("custom-handle");
          var slider_value = custom_handle.style.left;
          slider_value = slider_value.substring(0, slider_value.length - 1);
          
          console.log(slider_value);

          $.ajax({
                    url: '/search',
                    data: JSON.stringify({'class_name':class_results, 'tag_name':tag_results, 'slider_value':slider_value}),
                    contentType: "application/json",
                    type: 'POST',
                    success: function(response) {
                      // success
                      value = JSON.parse(response)
                      results = []

                      value.recommendations.forEach(function(recommendation) {
                        results.push(createRecommendationComponent(recommendation))
                      });
                        
                      $("#results").append(results);
                      readMore()
                      

                    },
                    error: function(error) {
                      console.log("ERROR");
                    }
                });
        }


        function readMore() {
          var showChar = 100;
          var ellipsestext = "...";
          var moretext = "more";
          var lesstext = "less";
          $('.more').each(function() {
          var content = $(this).html();

          if(content.length > showChar) {

            var c = content.substr(0, showChar);
            var h = content.substr(showChar);

            var html = c + '<span class="moreelipses">'+ellipsestext+'</span><span class="morecontent"><span>' + h + '</span><a href="" class="morelink">'+moretext+'</a></span>';

            $(this).html(html);
          }

          });

          $(".morelink").click(function(){
            if($(this).hasClass("less")) {
              $(this).removeClass("less");
              $(this).html(moretext);
            } else {
              $(this).addClass("less");
              $(this).html(lesstext);
            }
            $(this).parent().prev().toggle();
            $(this).prev().toggle();
            return false;
          });
        }
        </script>
        {% endblock %}
    </body>

</html>